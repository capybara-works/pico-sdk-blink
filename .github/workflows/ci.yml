name: Build and test (local-equivalent)

on:
  push:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      PICO_SDK_PATH: ~/pico/pico-sdk
      SDK_VERSION: 2.0.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Cache Pico SDK
      # ---------------------------------------------------------
      - name: Cache Pico SDK
        id: cache-pico-sdk
        uses: actions/cache@v4
        with:
          path: ~/pico
          key: ${{ runner.os }}-pico-sdk-${{ env.SDK_VERSION }}

      # ---------------------------------------------------------
      # Install toolchain
      # ---------------------------------------------------------
      - name: Set up the toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            wget

          # Install ARM GCC 11.3.rel1 (Same as Devcontainer)
          wget https://developer.arm.com/-/media/Files/downloads/gnu/11.3.rel1/binrel/arm-gnu-toolchain-11.3.rel1-x86_64-arm-none-eabi.tar.xz
          tar xf arm-gnu-toolchain-11.3.rel1-x86_64-arm-none-eabi.tar.xz
          sudo mv arm-gnu-toolchain-11.3.rel1-x86_64-arm-none-eabi /usr/local/arm-none-eabi
          echo "/usr/local/arm-none-eabi/bin" >> $GITHUB_PATH

      # ---------------------------------------------------------
      # Install Pico SDK if cache is missing
      # ---------------------------------------------------------
      - name: Set up the Pico SDK
        if: steps.cache-pico-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/pico
          cd ~/pico
          git clone https://github.com/raspberrypi/pico-sdk.git --depth 1 --branch ${SDK_VERSION}
          cd pico-sdk && git submodule update --init

      # ---------------------------------------------------------
      # Run unified local+CI build/test script
      # ---------------------------------------------------------
      - name: Run build_and_test.sh
        run: |
          cd ${{ github.workspace }}
          chmod +x ./build_and_test.sh
          ./build_and_test.sh

      # ---------------------------------------------------------
      # Upload firmware (for later steps or manual download)
      # ---------------------------------------------------------
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: build/blink.*
          
  # ========================================================================
  # Wokwi CI test
  # ========================================================================
  test-on-wokwi:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3
      - name: Download firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware
          path: build

      - name: Test on Wokwi
        uses: wokwi/wokwi-ci-action@v1
        with:
          token: ${{ secrets.WOKWI_CLI_TOKEN }}
          path: .
          timeout: 5000
          scenario: 'blink.test.yaml'
